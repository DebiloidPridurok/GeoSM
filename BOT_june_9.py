from telegram import ReplyKeyboardMarkup, ReplyKeyboardRemove, Update
from telegram.ext import (
    Application,
    CommandHandler,
    ContextTypes,
    ConversationHandler,
    MessageHandler,
    filters,
)
import sqlite3
import logging
import os
from pathlib import Path
import re

# ====== НАСТРОЙКА ПУТИ К БАЗЕ ДАННЫХ ======
DB_FOLDER = Path(r"/share/")
DB_FOLDER.mkdir(parents=True, exist_ok=True)
DB_PATH = DB_FOLDER / "bot_messages.db"
SUGGESTIONS_DB_PATH = DB_FOLDER / "suggestions.db"

logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s", 
    level=logging.INFO
)
logger = logging.getLogger(__name__)

CATEGORY, SUBCATEGORY, QUESTION, SUGGESTION = range(4)
BACK_BUTTON = "⬅️ Назад"

bot_data = {
    "Присутствие/отсутствие на работе": {
        "Опоздание": {
            "Что делать если я опаздываю/опоздал": "**При опоздании сотрудники ГК информируют об этом своих руководителей. Сотрудник ОКК фиксирует опоздание сотрудника на основании данных, полученных при контроле системы СКУД. Сотрудник ОКК делает информационные рассылки писем по фактам опозданий еженедельно и по окончанию отчетного месяца руководителям подразделений согласно стандарту на процесс П2-01 «Контроль качества работы».**",
            "При опоздании на сколько минут нужно писать СЗ": "**В настоящее время сотруднику не нужно писать СЗ при опоздании.**",
            "Кому сообщать про опоздание": "**При опоздании сотрудники ГК информируют об этом своих руководителей. Сотрудник ОКК фиксирует опоздание сотрудника на основании данных, полученных при контроле системы СКУД. Сотрудник ОКК делает информационные рассылки писем по фактам опозданий еженедельно и по окончанию отчетного месяца руководителям подразделений согласно стандарту на процесс П2-01 «Контроль качества работы».**",
            "Размер штрафа за опоздание": "**Для того, чтобы узнать размер финансового замечания за опоздание необходимо обратиться в ОКК по номеру телефона 8 (960) 198-07-72 или по электронной почте okk@geo-sm.ru.**"
        },
        "Больничные": {
            "Какие документы необходимо направить при выходе на больничный и кому": "**При выходе с больничного необходимо сообщить номер больничного, дату ухода и выхода специалистам:\n1) отдела кадров: для учёта отсутствия сотрудника и оформления приказа.\n2) бухгалтерии: для расчёта и выплаты пособия по временной нетрудоспособности.\n\nВажно: Электронный больничный (ЭЛН) автоматически передаётся в ФСС и работодателю через информационную систему. В первый рабочий день после выхода с больничного сотрудник или его руководитель должен в течение дня уведомить электронным письмом ОКК (okk@geo-sm.ru), а также руководитель должен проставить верный график в отчете «АРМ работа с данными СКУД» в ПО 1С.**",
            "Я заболел": "**При невыходе на работу, когда сотрудник оформляет больничный лист (в том числе находясь в отпуске и т.п.), он должен уведомить своего руководителя об этом, а его руководитель в этот же день должны уведомить:\n- через WhatsApp:\n  - специалиста по кадрам - 8 (962) 511-13-71;\n  - ОКК - 8 (960) 198-07-72;\n- любым удобным способом - колл-центр (отдел продаж, при необходимости).\n\nОтветственность за предоставление информации несет руководитель сотрудника. В день ухода сотрудника на больничный его руководитель должен в ПО 1С в отчете «АРМ работа с данными СКУД» проставить в графике - «больничный».\n\nПо закрытию больничного листа сотрудник, при наличии возможности, любым удобным способом (звонок, мессенджеры) уведомляет непосредственного руководителя о дне выхода на работу. В первый рабочий день после выхода с больничного сотрудник или его руководитель должен в течение дня уведомить электронным письмом ОКК (okk@geo-sm.ru), а также руководитель должен проставить верный график в отчете «АРМ работа с данными СКУД» в ПО 1С. Ответственность за предоставление информации несет руководитель сотрудника.**",
            "Оформление больничного листа": "**Листок нетрудоспособности (больничный лист) выдаётся медицинским учреждением в бумажном или электронном виде. Для оформления больничного вы должны обратиться с паспортом и полисом ОМС (ДМС) к врачу.**",
            "Как оплачивается больничный": "**В случае, если болеет сам сотрудник- то первые три дня больничного оплачивает работодатель, последующие дни оплачивает СФР (Социальный фонд России). Если сотрудник оформляет больничный по уходу за ребенком, то все дни оплачиваются СФР. При стаже более 8-ми лет - 100% среднего заработка, при стаже от 5-ти до 8-ми лет - 80% среднего заработка, 60% - при стаже менее 5-ти лет.**",
            "Кому сообщить о болезни, если не выхожу на работу": "**При невыходе на работу, когда сотрудник оформляет больничный лист (в том числе находясь в отпуске и т.п.), он должен уведомить своего руководителя об этом, а его руководитель в этот же день должны уведомить:\n- через WhatsApp:\n  - специалиста по кадрам - 8 (962) 511-13-71;\n  - ОКК - 8 (960) 198-07-72;\n- любым удобным способом - колл-центр (отдел продаж, при необходимости).\n\nОтветственность за предоставление информации несет руководитель сотрудника. В день ухода сотрудника на больничный его руководитель должен в ПО 1С в отчете «АРМ работа с данными СКУД» проставить в графике - «больничный».\n\nПо закрытию больничного листа сотрудник, при наличии возможности, любым удобным способом (звонок, мессенджеры) уведомляет непосредственного руководителя о дне выхода на работу. В первый рабочий день после выхода с больничного сотрудник или его руководитель должен в течение дня уведомить электронным письмом ОКК (okk@geo-sm.ru), а также руководитель должен проставить верный график в отчете «АРМ работа с данными СКУД» в ПО 1С. Ответственность за предоставление информации несет руководитель сотрудника.**",
            "Что делать, если продлили больничный": "**Если у сотрудника продлевают больничный, то ему необходимо проинформировать об этом своего руководителя.**",
            "Что делать если заболел, но смогу выздороветь в течение 2х дней": "**Если вы заболеваете и не берете официальный больничный, то в этом случае вам необходимо оформить административный отпуск. Сотруднику, берущему административный, либо руководителю сотрудника необходимо уведомить всех заинтересованных лиц до начала рабочего времени:\n- через WhatsApp:\n  - специалиста по кадрам - 8 (962) 511-13-71;\n  - ОКК - 8 (960) 198-07-72;\n- любым удобным способом - колл-центр (для отдела продаж, при необходимости);\n- либо уведомить сотрудников ГК через общий чат GeoSM в Rocket.Chat.\n\nОтветственность за предоставление информации несет руководитель сотрудника.**",
            "Что делать при выходе с больничного": "**По закрытию больничного листа сотрудник, при наличии возможности, любым удобным способом (звонок, мессенджеры) уведомляет непосредственного руководителя о дне выхода на работу. В первый рабочий день после выхода с больничного сотрудник или его руководитель должен в течение дня уведомить электронным письмом ОКК (okk@geo-sm.ru), а также руководитель должен проставить верный график в отчете «АРМ работа с данными СКУД» в ПО 1С. Ответственность за предоставление информации несет руководитель сотрудника. СЗ при оформлении больничного листа создавать не нужно.**"
        },
        "Административные": {
            "Что делать, если нужно взять админ": "**При необходимости планового отсутствия сотрудника на час и более либо полный рабочий день (или несколько дней) сотрудник составляет СЗ в 1С, выбрав шаблон: «Заявление о предоставлении отпуска без сохранения заработной платы (за свой счет)» с указанием времени во вкладке «Учет времени» и запускает СЗ на согласование. Сотруднику, берущему административный, либо руководителю сотрудника необходимо уведомить всех заинтересованных лиц до начала рабочего времени:\n- через WhatsApp:\n  - специалиста по кадрам - 8 (962) 511-13-71;\n  - ОКК - 8 (960) 198-07-72;\n- любым удобным способом - колл-центр (для отдела продаж, при необходимости);\n- либо уведомить сотрудников ГК через общий чат GeoSM в Rocket.Chat.\n\nОтветственность за предоставление информации несет руководитель сотрудника.**",
            "Срочное оформление СЗ на админ без доступа в 1С (коллега не может написать)": "**Если у сотрудника не получается создать СЗ, то он может написать заявление на административный отпуск от руки в свободной форме на листе формата А4 и отправить своему руководителю или всем заинтересованным лицам:\n- через WhatsApp:\n  - специалисту по кадрам - 8 (962) 511-13-71;\n  - ОКК - 8 (960) 198-07-72.\n\nПосле отправки написанного заявления сотрудник или его руководитель должны уведомить:\n- любым удобным способом - колл-центр (для отдела продаж, при необходимости);\n- либо уведомить сотрудников ГК через общий чат GeoSM в Rocket.Chat.\n\nОтветственность за предоставление информации несет руководитель сотрудника. По приходе на рабочее место сотрудник создает СЗ в 1С, выбрав шаблон: «Заявление о предоставлении отпуска без сохранения заработной платы (за свой счет)», указывая фактическое время отсутствия во вкладке «Учет времени» и запускает СЗ на согласование. Вкладывать написанное заявление на административный отпуск в СЗ не требуется. Контроль за оформлением СЗ несет руководитель подразделения сотрудника.**",
            "Куда передавать заявления на админ, написанные от руки": "**Заявление на административный отпуск от руки в свободной форме на листе формата А4 необходимо отправить своему руководителю или всем заинтересованным лицам:\n- через WhatsApp:\n  - специалисту по кадрам - 8 (962) 511-13-71;\n  - ОКК - 8 (960) 198-07-72.\n\nПосле отправки написанного заявления сотрудник или его руководитель должны уведомить:\n- любым удобным способом - колл-центр (для отдела продаж, при необходимости);\n- либо уведомить сотрудников ГК через общий чат GeoSM в Rocket.Chat.\n\nОтветственность за предоставление информации несет руководитель сотрудника.**",
            "Что делать, если необходимо уйти раньше с работы": "**В случае завершения рабочего дня ранее положеного времени по согласованию с руководителем необходимо оформить СЗ на административный отпуск на тот промежуток времени, который необходим сотруднику.**",
            "Что делать, если с утра внезапно иду в админ": "**При необходимости внепланово отсутствия сотрудник составляет СЗ в 1С, выбрав шаблон: «Заявление о предоставлении отпуска без сохранения заработной платы (за свой счет)», с указанием времени во вкладке «Учет времени» и запускает СЗ на согласование. Если у сотрудника не получается создать СЗ, то он может написать заявление на административный отпуск от руки в свободной форме на листе формата А4 и отправить своему руководителю или всем заинтересованным лицам:\n- через WhatsApp:\n  - специалисту по кадрам - 8 (962) 511-13-71;\n  - ОКК - 8 (960) 198-07-72.\n\nПосле отправки написанного заявления сотрудник или его руководитель должны уведомить:\n- любым удобным способом - колл-центр (для отдела продаж, при необходимости);\n- либо уведомить сотрудников ГК через общий чат GeoSM в Rocket.Chat.\n\nОтветственность за предоставление информации несет руководитель сотрудника. По приходе на рабочее место сотрудник создает СЗ в 1С, выбрав шаблон: «Заявление о предоставлении отпуска без сохранения заработной платы (за свой счет)», указывая фактическое время отсутствия во вкладке «Учет времени» и запускает СЗ на согласование. Вкладывать написанное заявление на административный отпуск в СЗ не требуется. Контроль за оформлением СЗ несет руководитель подразделения сотрудника.**"
        },
        "Другое": {
            "Сколько можно проводить времени в комнате отдыха": "**В комнате отдыха можно находится в свободное от работы время: 2 перерыва по 15 минут и 48 минут обеденного перерыва.**",
            "Какие причины нужно указывать при отсутствии на работе": "**При отсутствии на работе в СЗ необходимо указывать объективные причины, например, по семейным обстоятельствам, в связи с рождением ребенка, в связи с регистрацией брака или др.**",
            "Оформление отсутствия на рабочем месте по личным причинам": "**При необходимости внепланово отсутствия сотрудник составляет СЗ в 1С, выбрав шаблон: «Заявление о предоставлении отпуска без сохранения заработной платы (за свой счет)», с указанием времени во вкладке «Учет времени» и запускает СЗ на согласование. Если у сотрудника не получается создать СЗ, то он может написать заявление на административный отпуск от руки в свободной форме на листе формата А4 и отправить своему руководителю или всем заинтересованным лицам:\n- через WhatsApp:\n  - специалисту по кадрам - 8 (962) 511-13-71;\n  - ОКК - 8 (960) 198-07-72.\n\nПосле отправки написанного заявления сотрудник или его руководитель должны уведомить:\n- любым удобным способом - колл-центр (для отдела продаж, при необходимости);\n- либо уведомить сотрудников ГК через общий чат GeoSM в Rocket.Chat.\n\nОтветственность за предоставление информации несет руководитель сотрудника. По приходе на рабочее место сотрудник создает СЗ в 1С, выбрав шаблон: «Заявление о предоставлении отпуска без сохранения заработной платы (за свой счет)», указывая фактическое время отсутствия во вкладке «Учет времени» и запускает СЗ на согласование. Вкладывать написанное заявление на административный отпуск в СЗ не требуется. Контроль за оформлением СЗ несет руководитель подразделения сотрудника.**",
            "Нужно ли писать СЗ на удаленный доступ, если он будет пол день или один день": "**При переводе сотрудника временно на удаленный режим рабочего дня независимо от продолжительности рабочего процесса (необходимый, вынужденный срочный, только по решению руководителя) сотрудник до начала работы на удаленном доступе создает СЗ в 1С «Работа на удаленном доступе».**",
            "Что делать, если уезжаешь на встречу с клиентом/частично отсутствуешь в офисе": "**Если поездка сотрудника по служебным делам ограничивается территорией Нижегородской области или сотрудник направляется в рп. Ильиногорск, то приказ и ЗК не оформляются, сотрудник перед поездкой:\n- создает СЗ «Согласование рабочей поездки», куда вносит информацию о цели рабочей поездки с указанием названия контрагента, поставщика и прочих, отображая время отъезда и приезда на место;\n- при необходимости предоставления топливной карты (возмещение затрат ГСМ) на определенный литраж создает СЗ «Объяснительная (Свободная форма)», в которой указывает номер СЗ, относящейся к поездке (СЗ «Согласование рабочей поездки»);\n- осуществляет информирование о рабочей поездке через общий чат сотрудников компании.**",
            "Как оформить командировку, какие документы необходимы": "**При получении от руководителя подразделения информации о направлении в служебную командировку, сотрудник планирует командировку так, чтобы даты прибытия и убытия не приходились на выходные или праздничные дни. Сотрудник создает ЗК в ПО 1С в статусе «черновик», а затем, при подтверждении командировки, переводит ЗК в статус «создан» и проводит документ, заполняет обязательные поля согласно приложению ЗК в статусе «черновик» не участвует в проверке, проверка информации осуществляется на статусе «создан». Сотрудник информирует специалиста по кадрам о планируемой командировке не менее чем за 2 рабочих дня с указанием номера ЗК. Специалист по кадрам создает приказ на командировку по форме приложения 5 в день уведомления командируемым сотрудником или до конца следующего рабочего дня. Графы в приказе заполняются полностью, согласно унифицированной форме. Командируемый получает документ по электронной почте, распечатывает, подписывает и вкладывает скан приказа в ЗК во вкладку «Файлы», или приходит в ДУП для ознакомления и подписания приказа, после чего также вкладывает скан приказа в ЗК, оригинал приказа возвращает специалисту по кадрам. При условии срочной командировки и/или фактическом отсутствии командируемого, скан приказа должен быть вложен в ЗК руководителем подразделения. После внесения подписанного приказа в ЗК, сотрудник уведомляет через обсуждения в 1С руководителя подразделения о необходимости согласовать ЗК. Руководитель командируемого сотрудника, получив уведомление через обсуждения в ЗК, согласовывает документ и ставит статус заявки «согласовано». Если командировка планируется заблаговременно, но не менее чем за 2 дня до отъезда, то командируемый для покупки билетов и бронирования гостиницы информирует помощника директора с указанием номера ЗК. Помощник директора оформляет из ЗК заявку на РДС в соответствии инструкцией на покупку билетов и оплату гостиниц при плановых командировках, которые оформлены заблаговременно, на всех, кроме отдела проектных продаж. Заявка на РДС должна быть привязана к ЗК. При срочных командировках сам командируемый сотрудник или его руководитель создает заявку на РДС для приобретения билетов. Руководителям подразделений рекомендуется при создании РДС осуществлять контроль соответствия наименования юрлица, от которого создается РДС, и трудоустройства подотчетного лица в этом юрлице. Автор заявки на РДС запускает эту заявку на согласование, руководитель командируемого сотрудника согласовывает заявку на РДС. На основании согласованной заявки на РДС денежные средства выдаются наличными в кассе или по усмотрению бухгалтерии перечисляются на карту сотруднику на следующий рабочий день. Все выдачи/перечисления ДС под отчет на командировочные расходы сотрудник отдела бухгалтерии осуществляет только при наличии проведенного ДУП приказа на командировку. Командированный сотрудник обязан сохранять все документы, подтверждающие расходы выданных денежных средств, произведенные во время командировки.**",
            "Когда менять статус на «в работе» в заявке на командировку, кто его меняет": "**Ответ не найден в предоставленных данных.**",
            "Нужно ли оформлять командировку, если ты едешь по Ниж. области /на производство": "**Если поездка сотрудника по служебным делам ограничивается территорией Нижегородской области или сотрудник направляется в рп. Ильиногорск, то приказ и ЗК не оформляются, сотрудник перед поездкой:\n- создает СЗ «Согласование рабочей поездки», куда вносит информацию о цели рабочей поездки с указанием названия контрагента, поставщика и прочих, отображая время отъезда и приезда на место;\n- при необходимости предоставления топливной карты (возмещение затрат ГСМ) на определенный литраж создает СЗ «Объяснительная (Свободная форма)», в которой указывает номер СЗ, относящейся к поездке (СЗ «Согласование рабочей поездки»);\n- осуществляет информирование о рабочей поездке через общий чат сотрудников компании.**"
        }
    },
    "Отпуск и выходные": {
        "Отпуск": {
            "Планирование графика отпусков на следующий год": "**График отпуска на следующий год составляется в конце текущего года, даты отпуска согласовываются с непосредственным руководителем.**",
            "Как расчитываются больничные и отпускные": "**Больничные и отпускные дни рассчитываются по следующей формуле: средний дневной заработок = заработок за расчетный период / (29.3 х 12). Оплата за отпуск= Средний дневной заработок х количество календарных дней отпуска + если месяц отработан не полостью, то 29.3:кол-во календарных дней месяца х количество \"отработанных\" календарных дней.**",
            "Кому передавать задачи при уходе в отпуск": "**Сотрудник сам определяет ответственных по выполнению каждой задачи по списку дел и в случае отказа других сотрудников отдела принять задачи сотрудника, уходящего в отпуск, решение по распределению задач принимает руководитель сотрудника. Не менее чем за три дня до ухода в отпуск сотрудник проводит короткие встречи со всеми, кому он передал дела для того, чтобы получить/разработать план по проведению работ и уточнить готовность к выполнению задач.**",
            "Через какое время дается отпуск новому сотруднику": "**Новый сотрудник может пойти в отпуск по истечении 6 месяцев на 14 дней, трех месяцев на 7 дней (по согласованию с руководителем).**",
            "За какое время до отпуска писать заявление": "**Заявление на отпуск необходимо писать за 2 недели до начала предполагаемого отпуска.**",
            "Когда выплачиваются отпускные": "**Отпускные выплачиваются не позднее, чем за три дня до начала отпуска.**",
            "Я пропустил график отпусков": "**Неотгуленный вовремя отпуск можно отгулять в следующем месяце, но желательно не нарушать график отпусков.**",
            "За какой минимальный срок нужно написать заявление на отпуск": "**Заявление на отпуск необходимо написать минимум за 5 дней.**",
            "Сколько осталось неотгуленных дней отпуска": "**Нужно обратиться в отдел персонала по электронной почте all_hr@geo-sm.ru.**"
        },
        "Выходные": {
            "Производственный календарь": "**Внутри компании перед каждым праздничным днем делается корпоративная рассылка по дням, когда отдыхаем и до какого времени работаем в предпраздничный день. Официальный производственный календарь можно найти по ссылке: https://www.consultant.ru/law/ref/calendar/proizvodstvennye/2025/**",
            "Если суббота - рабочий день, как работаем в пятницу": "**Если суббота установлена рабочим днем, то в пятницу сотрудники работают полный рабочий день, а в субботу - по графику пятницы.**"
        }
    },
    "Все вопросы про пропуск": {
        "Где посмотреть данные по СКУДу": "**Данные по СКУД-системе предоставляются непосредственно руководителям, при его отсутствии сотрудник может обратиться в отдел IT.**",
        "Запрос скриншотов с камер вдн при отсутствии пропуска": "**Если сотрудник пришел с утра без пропуска, достаточно сразу же написать СЗ на отсутствие пропуска, а также написать ФИ сотрудника, с кем вошел в офис, в таком случае скриншот не понадобится. В остальных случаях нужно оформить заявку на support@geo-sm.ru с датой, примерным временем входа и сотрудником с которым входил (по возможности).**",
        "Оформление пропуска на территорию для сторонних лиц": "**Пропуск на территорию для сторонних лиц не оформляется. При необходимости прохода на территорию сторонних лиц необходимо обратиться в отдел СБ 8(960) 186-83-21.**",
        "Что делать, если забыл/потерял пропуск": "**Если сотрудник потерял/забыл индивидуальную бесконтактную карту доступа, то он может войти на площадку/в офис вместе с другим сотрудником ГК. По приходе на рабочее место сотрудник оформляет СЗ, выбрав в ПО 1С в разделе «Служебные записки» шаблон: «Заявка на выдачу пропуска (бесконтактной карты)». В данную СЗ сотрудник вносит информацию об отсутствии индивидуальной бесконтактной карты и указывает дату, фамилию, инициалы сотрудника, вместе с которым он вошел в офис или чью индивидуальную бесконтактную карту он использовал при входе, затем лично обращается в ДУП для получения новой или временной индивидуальной бесконтактной карты. Запрашивать и вкладывать изображение с фотофиксацией входа/выхода в данном случае не требуется.**"
    },
    "ЗП и выплаты": {
        "ЗП": {
            "Когда привозят управленческую ЗП (ПСК)": "**Как правило, в 12-13 числах каждого месяца если не выпадает на выходные и праздники (не позднее 14-го числа каждого месяца).**",
            "Когда повышение ЗП": "**Индексация заработной платы производится раз в год. Более конкретные сроки можно уточнить у своего руководителя.**",
            "Из чего складывается ЗП": "**Для сотрудников офиса: оклад+ регулярная премия+ стимулирующая премия. Для сотрудников ПСК: оклад+ регулярная премия+ стимулирующая премия + ночные смены.**",
            "Где касса для получения ЗП, с кем связаться по вопросам ЗП": "**Касса находится на первом этаже, кабинет 5. По вопросам заработной платы необходимо обращаться к Каргиной Анастасии или составить общий запрос на почту бухгалтерии all_buh@geo-sm.ru.**",
            "Периодичность индексации ЗП": "**Индексация зарплаты происходит раз в год.**",
            "Какая ЗП у сотрудников на испытательном сроке": "**О данной информации сотрудник должен быть осведомлен при трудоустройстве.**",
            "Когда выплачивается аванс": "**Расчет и выплата заработной платы осуществляется два раза в месяц: 10 и 25 числа (10 число- заработная плата за предыдущий месяц, 25 число- аванс за нынешний месяц).**",
            "Что делать, если я не получил полный расчет по зарплате": "**Если сотрудник не получил полный расчет по ЗП, то ему необходимо обратиться к своему руководителю.**",
            "Когда выплата ЗП за текущий месяц": "**Расчет и выплата заработной платы осуществляется два раза в месяц: 10 и 25 числа (10 число- заработная плата за предыдущий месяц, 25 число- аванс за нынешний месяц).**"
        },
        "Выплаты": {
            "Как оплачивается больничный": "**При стаже более 8-ми лет - 100% среднего заработка, при стаже от 5-ти до 8-ми лет - 80% среднего заработка, 60% - при стаже менее 5-ти лет.**",
            "В какие сроки выплачиваются отпускные": "**Отпускные выплачиваются не позднее, чем за три дня до начала отпуска.**"
        },
        "Другое (13-ая зп, переработка)": {
            "Оплата удаленной работы": "**Работа на удаленном доступе оплачивается также, как и работа в офисе.**",
            "Кто отв.лицо за формирование и выдачу документов для гос. Учреждений": "**По вопросам формирования заявки и выдачи документов для предоставления по запросу в гос. учреждения (справка с места работы, справка о доходах) необходимо обращаться к Анастасии Каргиной (в Rocket.chat намите кнопку каталог (книжка с решеткой), далее введите название \"Анастасия Каргина\" и нажмите на кнопку \"поиск\". По запросу вам выйдут данные сотрудника)).**",
            "Оказывается ли сотрудникам материальная помощь": "**Да, материальная помощь оказывается в случае ухода в декрет, смерти близкого родственника.**",
            "Оплата работы в праздничные дни": "**Для сотрудников офиса: работа в праздничные дни не оплачивается. Для сотрудников ПСК: работа в праздничные дни в двойном размере.**",
            "Как оплачивается переработка": "**Для сотрудников офиса: переработки не оплачиваются. Для сотрудников ПСК: переработа оплачивается исходя из отработанных часов сверх графика единоразовой премией.**",
            "Как оплачивается работа за сотрудника, ушедшего в отпуск": "**Для сотрудников офиса: работа за сотрудника, ушедшего в отпуск, не оплачивается. Для сотрудников ПСК: предусмотрено замещение.**",
            "Предусмотрена ли выплата 13 ЗП": "**Нет, в компании не предусмотрена выплата 13-ой ЗП.**",
            "Когда писать заявление о предоставлении налогового вычета на детей": "**Заявление о предоставлении налогового вычета на детей берется у сотрудника отдела кадров при трудоустройстве.**",
            "Какие документы нужны для предоставления налогового вычета на детей": "**Для предоставления налогового вычета на детей необходима копия свидетельства о рождении или паспорта.**",
            "Как запросить справку 2НДФЛ": "**Запросить справку 2-НДФЛ можно через своего руководителя, который пишет письмо Анастасии Каргиной с указанием ФИО и периодом, за который необходима справка.**",
            "Предоставляет ли компания услуги по оформлению документов по возврату подоходного налога для сотрудников компании": "**В настоящее время компания не предоставляет услуги по оформлению документов по возврату подоходного налога для сотрудников компании.**",
            "Кто отвечает за оформление документов по возврату подоходного налога": "**В настоящее время компания не предоставляет услуги по оформлению документов по возврату подоходного налога для сотрудников компании.**",
            "Где касса для получения наличных, с кем связаться по вопросам ЗП": "**Касса находится на первом этаже, кабинет 5. По вопросам заработной платы необходимо обращаться к Каргиной Анастасии или составить общий запрос на почту бухгалтерии all_buh@geo-sm.ru.**",
            "Как расчитываются больничные и отпускные": "**Больничные и отпускные дни рассчитываются по следующей формуле: средний дневной заработок = заработок за расчетный период / (29.3 х 12). Оплата за отпуск= Средний дневной заработок х количество календарных дней отпуска + если месяц отработан не полостью, то 29.3 : кол-во календарных дней месяца х количество \"отработанных\" календарных дней.**"
        }
    },
"Отдел персонала": {
    "Условия акции «Приведи друга»": "Если у вас есть знакомый, которого вы можете порекомендовать нам на работу, то\n1. Первым делом нужно сообщить об этом в отдел персонала. Необходимо предоставить ФИО, резюме и номер телефона кандидата.\n2. Отдел персонала вносит информацию в базу данных о том, что этот кандидат – ваша рекомендация. Далее сотрудники отдела персонала сами связываются с кандидатом и приглашают его на собеседование.\n3. Порядок выплаты следующий: 500 р. после трудоустройства сотрудника, 10 000 р. после того, как сотрудник отработал 3 месяца, успешно прошел испытательный срок и он остается работать в компании. Если данный сотрудник не доработал 3 месяца по разным причинам, то выплата не осуществляется.\n4. Премии выплачиваются вместе с зарплатой 10-15 числа.\nЧтобы получить премию необходимо соблюдать эти правила. Если вы привели сотрудника и не уведомили Отдел Персонала заранее, до его трудоустройства, то премия выплачиваться не будет.",
    "Как открыть вакансию на подбор персонала": "Для того, чтобы открыть вакансию на подбор персонала, необходимо заполнить форму заявки на подбор и отправить запрос с заполненной заявкой на рабочую почту отдела персонала **all_hr@geo-sm.ru**.\nФорма заявки на подбор персонала: https://disk.yandex.ru/i/H3zt5qMkG84r4w",
    "Как трудоустроить нового сотрудника": "Для того, чтобы трудоустроить нового сотрудника, нужно сообщить в отдел персонала о решении трудоустроить нового сотрудника, а далее действовать согласно внутреннему документу \"Положение по требованиям к созданию служебных записок при трудоустройстве, внутреннем переводе, изменении заработной платы\", который можно найти по ссылке: https://disk.yandex.ru/i/0f8jiGBk5sQUNw"
},
"Обучение сотрудников": {
    "Где найти обучающий материал": "Все обучающие материалы находятся на платформе обучения Ispring. Доступ на платформу предоставляется при трудоустройстве сотрудника. Также получить доступ на платформу через корпоративный портал в разделе \"Обучение\". Если возникают проблемы или есть запрос на дополнительные курсы и т.д., то нужно написать на рабочую почту отдела персонала **all_hr@geo-sm.ru**.",
    "Планируется ли обучение по повышению квалификации сотрудников в 2025 г.": "Да, планируется проведение обучения по повышению квалификации сотрудников. Будем рады получить ваши пожелания по обучению в раздел \"Предложения по улучшению\".",
    "Корпоративная библиотека: будет ли пополняться. Что делать, если хочу определенную книгу": "Корпоративная библиотека пополняется регулярно. Заявки на определенные книги вы можете писать в Rocket.chat специалисту по корпоративной культуре."
},
"Другое": {
    "Офис": {
        "Как узнать, кто является руководителем у МОП": "Для того, чтобы узнать руководителя определенного МОП необходимо сделать следующее:\nв Rocket.chat нажмите кнопку каталог (книжка с решеткой), далее введите ФИ менеджера и нажмите на кнопку \"поиск\". По запросу вам выйдет профиль менеджера, а в его имени в скобках будет ФИ его РОП.",
        "Приложение шлагбаума (как настроить/где скачать)": "Для сотрудника доступ к шлагбауму предоставляется по заявке на **support@geo-sm.ru**.\nВ заявке необходимо указать следующую информацию:\n1. Номер телефона\n2. Госномер машины\n3. Марка модель.",
        "Как поменять график перерывов/обедов": "Для того, чтобы поменять график обедов и перерывов необходимо обратиться к своему руководителю для внесения изменений в отчет АРМ работа с данными СКУД. Руководитель может изменить график в текущем дне на завтрашний и последующие дни. В экстренном случае руководитель может обратиться в ОКК для смены графика день в день.",
        "Где узнать про корп. мероприятия": "Анонсы всех мероприятий публикуются на портале в разделе \"Мероприятия\", а также своевременно дублируются в Rocket/chat. Если у вас есть вопросы по корпоративным мероприятиям или предложения, то вы можете обратиться в отдел маркетинга.",
        "Как долго можно находится в комнате отдыха": "В комнате отдыха можно находится в свободное от работы время: 2 перерыва по 15 минут и 48 минут обеденного перерыва.",
        "Где найти список поставщиков": "В прайсе для менеджеров, расположенном в папке: O:\\НАСТОЛЬНАЯ ПАПКА МЕНЕДЖЕРА ПО ПРОДАЖАМ\\Прайс для менеджеров находится ссылка на список поставщиков: https://yandex.ru/maps/?ll=42.171029%2C54.602453&mode=usermaps&source=constructorLink&um=constructor%3A4f867520704719d59440155c8b0fc3fa984e67a4289a897d344880e12ce57d70&z=5",
        "Запрос на отправку документов/образцов экспресс почтой(курьером)": "Для отправки образцов и рекламной продукции необходимо в программе 1С создать служебную записку (СЗ) \"Запрос на отправку документов/образцов экспресс почтой(курьером)\", оповестить офис-менеджера и согласовать с ним отправку.",
        "Как оставить заявку на посещение ПСК": "Написать письмо через Outlook на почту Степанова Алексея (**stepanov.a@geo-sm.ru**), Лукоянова Алексея (**lukoyanov.a@geo-sm.ru**), Лашина Александра (**lashin.a@geo-sm.ru**), Кирюшина Тимофея (**kiryushin.t@geo-sm.ru**), в копию РОП отдела, с указанием даты, времени посещения производства, данных менеджера, РОП и клиентов с указанием марок, моделей и государственных номеров автомобилей для оформления пропусков на территорию производства.",
        "Где посмотреть данные по СКУДу": "Данные по СКУД-системе предоставляются непосредственно руководителям, при его отсутствии сотрудник может обратиться в отдел IT.",
        "Где узнать рабочий номер сотрудника компании": "Для поиска сотрудников и информации о них существует 2 способа:\n1) на корпоративном портале: в поисковой строке введите полное название отдела и нажмите на кнопку \"поиск\". По запросу вам выйдет список сотрудников конкретного отдела.\n2) в Rocket.chat нажмите кнопку каталог (книжка с решеткой), далее введите название отдела и нажмите на кнопку \"поиск\". По запросу вам выйдет список сотрудников конкретного отдела.",
        "Порядок действий, если первым приходишь в офис/ последним его покидаешь": "Доступ для открытия офиса имеют сотрудники, у которых рабочий день начинается с 07-00 часов. При прибытии на работу ответственный сотрудник должен обойти здание офиса и визуально убедиться в целостности окон, дверей и иных запирающих устройств. После этого, закрепленным за ним ключом открыть входную дверь и снять с охранной сигнализации здание офиса. Если при осмотре здания выявляются поврежденные окна, двери и т.д. то сотрудник сразу должен сообщить об этом руководителю СБ по телефону и далее действовать согласно указаниям. При закрытии последний сотрудник должен обойти все помещения офиса и проверить, что все окна и запасные выходы заперты, а так же убедиться, что кроме него в здании никого не осталось. Далее сотрудник должен поставить через приборную панель здание под охрану, после чего покинуть его и закрыть дверь закрепленным за ним ключом. В случае, если последним уходит сотрудник, у которого нет индивидуального кода для постановки здания под охрану и ключа, то он должен уведомить своего непосредственного руководителя, что он задержится на работе, после чего руководитель сообщает об этом сотруднику СБ и действует согласно полученным указаниям."
    },
    "Общие": {
        "Я забыл дома рабочий телефон": "Если сотрудник забыл рабочий телефон, то ему необходимо написать заявку в IT- отдел по почте **support@geo-sm.ru** и попросить временно настроить переадресацию рабочего телефона на личный.",
        "Очередность действий запуска на согласование при создании СЗ": "Очередность действий запуска на согласование:\n\"Сохранить\".\n\"Провести\". Проводит документ, т.е. формирует движения, которые регистрируются этим документом.\n\"На согласование\". С помощью этой кнопки заявка отправляется в финансовый отдел.",
        "Как получить необходимые канцтовары": "При необходимости оформить заявку на канцелярию следует написать на почту **sec@geo-sm.ru**, добавив в письмо артикулы необходимых товаров с сайта https://www.officemag.ru/",
        "Формирование отчета по отделу": "Обучающее видео по формированию отчета по отделу можно найти по ссылке: https://disk.yandex.ru/i/xTGz8g8-XSCvXg",
        "Предоставляется ли сотрудникам полис ДМС": "В настоящий момент сотрудникам компании не предоставляется полис ДМС.",
        "Где посмотреть контакты сотрудников": "Для поиска сотрудников и информации о них существует 2 способа:\n1) на корпоративном портале: в поисковой строке введите полное название отдела и нажмите на кнопку \"поиск\". По запросу вам выйдет список сотрудников конкретного отдела;\n2) в Rocket.chat нажмите кнопку каталог (книжка с решеткой), далее введите название отдела и нажмите на кнопку \"поиск\". По запросу вам выйдет список сотрудников конкретного отдела.",
        "Где найти список сотрудников, работающих в определенном подразделении, и информацию о них": "Для поиска сотрудников и информации о них существует 2 способа:\n1) на корпоративном портале: в поисковой строке введите полное название отдела и нажмите на кнопку \"поиск\". По запросу вам выйдет список сотрудников конкретного отдела;\n2) в Rocket.chat нажмите кнопку каталог (книжка с решеткой), далее введите название отдела и нажмите на кнопку \"поиск\". По запросу вам выйдет список сотрудников конкретного отдела.",
        "Где хранится необходимый стандарт": "Все стандарты можно найти:\nна корпоративном портале в разделе \"Документация\";\nв общей папке по адресу O:\\_Инфо\\Стандарты процессов СМК 9015.",
        "Кто отв. лицо за формирование и выдачу документов для предоставления в гос.учреждения": "По вопросам формирования заявки и выдачи документов для предоставления по запросу в гос. учреждения (справка с места работы, справка о доходах) необходимо обращаться к Анастасии Каргиной (в Rocket.chat нажмите кнопку каталог (книжка с решеткой), далее введите название \"Анастасия Каргина\" и нажмите на кнопку \"поиск\". По запросу вам выйдут данные сотрудника)).",
        "К кому обращаться при необходимости ремонта мебели на рабочем месте": "При необходимости ремонта мебели на рабочем месте необходимо обратиться к специалисту АХО (в Rocket.chat нажмите кнопку каталог (книжка с решеткой), далее введите название \"АХО\" и нажмите на кнопку \"поиск\". По запросу вам выйдет список сотрудников, ответственных за вопросы АХО).",
        "Сколько длится испытательный срок, можно ли сократить": "Испытательный срок, как правило, составляет 3 месяца. Испытательный срок может быть сокращен по решению руководителя по итогам адаптации сотрудника и результатов работы.",
        "Как оформить пропуск на территорию для сторонних лиц": "Пропуск на территорию для сторонних лиц не оформляется. При необходимости прохода на территорию сторонних лиц необходимо обратиться в отдел СБ **8(960) 186-83-21**.",
        "Как оформить заявку на канцтовары": "При необходимости оформить заявку на канцелярию следует написать на почту **sec@geo-sm.ru**, добавив в письмо артикулы необходимых товаров с сайта https://www.officemag.ru/",
        "Предоставляются ли подарки детям сотрудников к Новому Году": "Да, для детей сотрудников предоставляются подарки на Новый год."
    },
    "ПСК": {
        "Почему ARM вечером один, утром уже другой": "Данное явление связано с увеличением машин в расписании (согласованные машины день в день: отдел логистики находит машину менеджерам именно в этот день).",
        "На какой срок выдается комплект спецодежды": "Комплект спецодежды выдается на 1 год (замена зависит от износа спецодежды).",
        "Какие штрафы предусмотрены на ПСК": "Для того, чтобы узнать размер финансового замечания и его виды необходимо обратиться в ОКК по номеру телефона **8 (960) 198-07-72** или по электронной почте **okk@geo-sm.ru**.",
        "Я не прошел алкотестер": "Если сотрудник не прошел алкотестер, то необходимо уведомить руководителя о сложившейся ситуации, затем следовать его инструкциям. Для руководителей: в первую очередь необходимо написать СЗ в 1С о сложившейся ситуации за сотрудника.",
        "Почему пригоняют машины до принятия продукции на склад": "Машины приезжают для отгрузки материала и на месте записываются на очередь, сотрудники отдела логистики не могут отследить готовность продукции.",
        "Почему операторы требуют паспорта от менеджеров": "Так происходит, потому что на данный момент нет тотального контроля за распоряжением и за всеми его стадиями, менеджер не всегда полностью контролирует каждый этап своего распоряжения и может упустить момент, когда нужно запросить паспорт или проконтролировать, чтобы он получил утверждение."
    }
},
"Удаленый доступ и вопросы IT": {
    "Оплата удаленной работы": "Работа на удаленном доступе оплачивается также, как и работа в офисе.",
    "Подключение удаленного доступа дома": "Подробную инструкцию по подключению удаленного доступа можно найти по ссылке: https://disk.yandex.com.am/i/tRLIHnRCg4h8lw",
    "Не работает терминал": "Если у сотрудника возникли проблемы в работе с терминалом, то ему следует обратиться в отдел IT. Служебный номер IT отдела **+79601886890**, рабочая почта **support@geo-sm.ru**.",
    "К кому обращаться при вопросах в 1С по оплате/реализации": "По вопросам, связанных с оплатой, реализацией в 1С, необходимо обращаться в отдел бухгалтерии через рабочую почту **all_buh@geo-sm.ru**.",
    "Оформление рабочего дня удаленно": "При переводе сотрудника временно на удаленный режим рабочего дня (необходимый, вынужденный срочный, только по решению руководителя) сотрудник до начала работы на удаленном доступе создает СЗ в 1С «Работа на удаленном доступе».",
    "Не работает корпоративная почта": "Если у сотрудника возникли проблемы в работе корпоративной почты, то ему следует обратиться в отдел IT. Служебный номер IT отдела **+79601886890**, рабочая почта **support@geo-sm.ru**.",
    "Настройка VPN для удаленной работы": "Подробную инструкцию по подключению VPN можно найти по ссылке: https://disk.yandex.com.am/i/tRLIHnRCg4h8lw",
    "Проблемы с доступом к CRM-системе": "Если у сотрудника возникли проблемы с доступом к CRM-системе, то ему следует обратиться в отдел IT. Служебный номер IT отдела **+79601886890**, рабочая почта **support@geo-sm.ru**.",
    "Я забыл пароль от учетной записи": "Если сотрудник забыл пароль от учетной записи, то ему следует обратиться в отдел IT. Служебный номер IT отдела **+79601886890**, рабочая почта **support@geo-sm.ru**."
},
"Вопросы ОП": {
    "Кому сообщить, если я задерживаюсь на встрече с клиентом": "Необходимо проинформировать своего РОП о задержке на встрече с клиентом, который в свою очередь передаст данные в ОКК. Также можно проинформировать ОКК напрямую через WhatsApp по номеру телефона **8 (960) 198-07-72**.",
    "К кому обращаться при вопросах в 1С по оплате/реализации": "По вопросам, связанных с оплатой, реализацией в 1С, необходимо обращаться в отдел бухгалтерии через рабочую почту **all_buh@geo-sm.ru**.",
    "Как можно улучшить оценку в следующем месяце": "Для улучшения оценки работы в следующем месяце необходимо провести работу над ошибками на основе отчета ОКК и в дальнейшем не допускать их.",
    "К кому обратиться для пересмотра оценки работы": "Чтобы подать апелляцию/рекламацию на проверенный БП, то необходимо внести данные по БП, а также свои комментарии, с чем не согласен и обоснование в гугл-таблицу спорных ситуаций. Ссылку на таблицу сотрудник ОКК направляет в каждом письме с промежуточными итогами.",
    "Как оставить заявку на посещение производства": "Написать письмо через Outlook на почту Степанова Алексея (**stepanov.a@geo-sm.ru**), Лукоянова Алексея (**lukoyanov.a@geo-sm.ru**), Лашина Александра (**lashin.a@geo-sm.ru**), Кирюшина Тимофея (**kiryushin.t@geo-sm.ru**), в копию РОП отдела, с указанием даты, времени посещения производства, данных менеджера, РОП и клиентов с указанием марок, моделей и государственных номеров автомобилей для оформления пропусков на территорию производства.",
    "За сколько нужно обработать входящее обращение": "Время, в течение которого необходимо обработать входящее обращение:\nТелефонный звонок - 15 минут,\nЭлектронные обращения - 30 минут.",
    "Где сдавать грейдирование": "Грейдирование сдается в присутствии сотрудника ОКК непосредственно в кабинете ОКК.",
    "Как начисляются бонусы за выполнение плана продаж": "Бонусы за выполнение плана продаж начисляются в соответствии с приказом \"О мотивации менеджеров отдела продаж ГеоСМ\" № 65-04/25 от 16 апреля 2025 года.",
    "Что делать, если не согласен с оценкой работы ОКК": "В обязанности сотрудников ОКК входит только фиксация несоответствия в работе сотрудников. Сотрудники отдела еженедельно рассылают все собранные данные руководителям подразделений, у своего РОП менеджер может узнать результаты. При несогласии с результатами, сотрудник может обратиться к своему непосредственному руководителю."
},
"Предложения по улучшению": {
        "Оставить предложение": "🔹 Напишите ваши предложения здесь и нажмите отправить"
    }}

def init_db():
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS messages (
            user_id INTEGER,
            username TEXT,
            message TEXT,
            date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    conn.commit()
    conn.close()

    conn = sqlite3.connect(SUGGESTIONS_DB_PATH)
    cursor = conn.cursor()
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS suggestions (
            user_id INTEGER,
            username TEXT,
            suggestion TEXT,
            date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    conn.commit()
    conn.close()

def save_message(user_id: int, username: str, message: str):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute(
        "INSERT INTO messages (user_id, username, message) VALUES (?, ?, ?)",
        (user_id, username, message)
    )
    conn.commit()
    conn.close()

def save_suggestion(user_id: int, username: str, suggestion: str):
    conn = sqlite3.connect(SUGGESTIONS_DB_PATH)
    cursor = conn.cursor()
    cursor.execute(
        "INSERT INTO suggestions (user_id, username, suggestion) VALUES (?, ?, ?)",
        (user_id, username, suggestion)
    )
    conn.commit()
    conn.close()

def clean_html(text):
    return re.sub(r"<.*?>", "", text)

async def log_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.message.from_user
    message_text = update.message.text
    save_message(user.id, user.username or "нет_username", message_text)
    logger.info(f"Сообщение от {user.id}: {message_text}")

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    await log_message(update, context)
    context.user_data.clear()
    categories = list(bot_data.keys())
    reply_keyboard = [categories[i:i + 3] for i in range(0, len(categories), 3)]

    await update.message.reply_text(
        "👋 Привет! Я — бот-помощник. Если что-то не работает, перезапусти бота нажатием на /start.\nВыбери категорию:",
        reply_markup=ReplyKeyboardMarkup(reply_keyboard, one_time_keyboard=True, resize_keyboard=True)
    )
    return CATEGORY

async def category(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    await log_message(update, context)
    user_choice = update.message.text

    if user_choice == BACK_BUTTON:
        return await start(update, context)

    if user_choice not in bot_data:
        await update.message.reply_text("⚠️ Ошибка: выбери категорию из кнопок.")
        return CATEGORY

    context.user_data['category'] = user_choice

    if user_choice == "Предложения по улучшению":
        await update.message.reply_text(
            "🔹 Напишите ваше предложение и отправьте сообщение.",
            reply_markup=ReplyKeyboardMarkup([[BACK_BUTTON]], one_time_keyboard=True, resize_keyboard=True)
        )
        return SUGGESTION

    content = bot_data[user_choice]

    # Если это словарь вопросов с текстами
    if all(isinstance(value, str) for value in content.values()):
        context.user_data['subcategory'] = None
        questions = list(content.keys())
        questions = [clean_html(q) for q in questions]
        reply_keyboard = [questions[i:i + 2] for i in range(0, len(questions), 2)]
        reply_keyboard.append([BACK_BUTTON])

        await update.message.reply_text(
            f"📌 Категория: <b>{user_choice}</b>\nВыбери вопрос:",
            reply_markup=ReplyKeyboardMarkup(reply_keyboard, one_time_keyboard=True, resize_keyboard=True),
            parse_mode="HTML"
        )
        return QUESTION

    subcategories = list(content.keys())
    subcategories = [clean_html(s) for s in subcategories]
    reply_keyboard = [subcategories[i:i + 2] for i in range(0, len(subcategories), 2)]
    reply_keyboard.append([BACK_BUTTON])

    await update.message.reply_text(
        f"🗂 Категория: <b>{user_choice}</b>\nВыбери подкатегорию:",
        reply_markup=ReplyKeyboardMarkup(reply_keyboard, one_time_keyboard=True, resize_keyboard=True),
        parse_mode="HTML"
    )
    return SUBCATEGORY

async def subcategory(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    await log_message(update, context)
    user_choice = clean_html(update.message.text)
    category = context.user_data.get('category')

    if user_choice == BACK_BUTTON:
        return await start(update, context)

    if not category or user_choice not in bot_data.get(category, {}):
        await update.message.reply_text("⚠️ Ошибка: подкатегория не найдена.")
        return await category(update, context)

    context.user_data['subcategory'] = user_choice
    questions = list(bot_data[category][user_choice].keys())
    questions = [clean_html(q) for q in questions]
    reply_keyboard = [questions[i:i + 2] for i in range(0, len(questions), 2)]
    reply_keyboard.append([BACK_BUTTON])

    await update.message.reply_text(
        f"📌 Подкатегория: <b>{user_choice}</b>\nВыбери вопрос:",
        reply_markup=ReplyKeyboardMarkup(reply_keyboard, one_time_keyboard=True, resize_keyboard=True),
        parse_mode="HTML"
    )
    return QUESTION

async def question(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    await log_message(update, context)
    user_choice = clean_html(update.message.text)
    category = context.user_data.get('category')
    subcategory = context.user_data.get('subcategory')

    if user_choice == BACK_BUTTON:
        if subcategory:
            subcategories = list(bot_data[category].keys())
            subcategories = [clean_html(s) for s in subcategories]
            reply_keyboard = [subcategories[i:i + 2] for i in range(0, len(subcategories), 2)]
            reply_keyboard.append([BACK_BUTTON])

            await update.message.reply_text(
                f"🗂 Категория: <b>{category}</b>\nВыбери подкатегорию:",
                reply_markup=ReplyKeyboardMarkup(reply_keyboard, one_time_keyboard=True, resize_keyboard=True),
                parse_mode="HTML"
            )
            return SUBCATEGORY
        else:
            return await start(update, context)

    answer = None
    try:
        if subcategory:
            answer = bot_data[category][subcategory].get(user_choice)
            questions = list(bot_data[category][subcategory].keys())
        else:
            answer = bot_data[category].get(user_choice)
            questions = list(bot_data[category].keys())
    except Exception as e:
        logger.error(f"Ошибка при поиске вопроса: {e}")
        await update.message.reply_text("⚠️ Ошибка при обработке вопроса.")
        return QUESTION

    if answer:
        await update.message.reply_text(answer, parse_mode="Markdown")
    else:
        await update.message.reply_text("⚠️ Вопрос не найден.")

    questions = [clean_html(q) for q in questions]
    reply_keyboard = [questions[i:i + 2] for i in range(0, len(questions), 2)]
    reply_keyboard.append([BACK_BUTTON])

    await update.message.reply_text(
        "➡️ Выбери другой вопрос или вернись назад:",
        reply_markup=ReplyKeyboardMarkup(reply_keyboard, one_time_keyboard=True, resize_keyboard=True)
    )
    return QUESTION

async def handle_suggestion(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    await log_message(update, context)
    user = update.message.from_user
    suggestion_text = update.message.text

    if suggestion_text == BACK_BUTTON:
        return await start(update, context)

    save_suggestion(user.id, user.username or "нет_username", suggestion_text)

    await update.message.reply_text(
        "✅ Спасибо за ваше предложение! Оно сохранено.",
        reply_markup=ReplyKeyboardMarkup([[BACK_BUTTON]], one_time_keyboard=True, resize_keyboard=True)
    )
    return SUGGESTION

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    await update.message.reply_text("❌ Диалог завершен. Чтобы начать заново, нажми /start.",
                                    reply_markup=ReplyKeyboardRemove())
    return ConversationHandler.END

async def unknown(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await update.message.reply_text("❓ Пожалуйста, выбери действие с помощью кнопок.")

async def error_handler(update: object, context: ContextTypes.DEFAULT_TYPE) -> None:
    logger.error(f"Произошла ошибка: {context.error}")

def main() -> None:
    init_db()
    application = Application.builder().token("7704376406:AAHbpP0wCuzk8U8VJSpq0w_odkIAJbHQxoE").build()

    conv_handler = ConversationHandler(
        entry_points=[CommandHandler("start", start)],
        states={
            CATEGORY: [MessageHandler(filters.TEXT & ~filters.COMMAND, category)],
            SUBCATEGORY: [MessageHandler(filters.TEXT & ~filters.COMMAND, subcategory)],
            QUESTION: [MessageHandler(filters.TEXT & ~filters.COMMAND, question)],
            SUGGESTION: [MessageHandler(filters.TEXT & ~filters.COMMAND, handle_suggestion)],
        },
        fallbacks=[
            CommandHandler("cancel", cancel),
            MessageHandler(filters.ALL, unknown)
        ],
    )

    application.add_handler(conv_handler)
    application.add_error_handler(error_handler)
    application.run_polling()

if __name__ == "__main__":
    main()

